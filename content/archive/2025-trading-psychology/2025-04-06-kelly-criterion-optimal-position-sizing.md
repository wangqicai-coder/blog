+++
date = '2025-04-06T10:15:00+08:00'
draft = false
title = 'Kelly公式：最优仓位的数学'
tags = ['Kelly公式', 'Kelly Criterion', '仓位管理', '最优下注', '期望值']
categories = ['交易心理学']
series = '交易心理学2025'
+++

## 引言：赌场里的秘密

**1956年，贝尔实验室**，物理学家John Kelly发表论文。

**问题**：如果你有内部信息（知道赔率有利），应该下注**多少**？

**答案**：**Kelly公式**——最大化长期资本增长率的最优下注比例。

**应用**：
- Edward Thorp：用Kelly公式在拉斯维加斯赚取数百万（21点）
- Warren Buffett、Bill Gross：用Kelly思想管理投资

**核心洞察**：
> "不是要不要下注，而是下注多少。"

今天我们探讨：Kelly公式的原理？如何应用于交易？为何大多数人会over-bet？

---

## 第一部分：Kelly公式的数学

### 基础公式

**Kelly Criterion（Kelly准则）**：

```
f* = (bp - q) / b

其中：
f* = 最优下注比例（占总资本的%）
b = 赔率（盈利时的收益倍数）
p = 胜率（获胜概率）
q = 1-p（失败概率）
```

**推导目标**：
- 最大化**几何平均增长率**（长期复利）

**例子**：

**场景**：抛硬币赌博
- 胜率p = 60%（作弊硬币，偏向正面）
- 赔率b = 1（赢了+100%，输了-100%）

**计算**：
```
f* = (1×0.6 - 0.4) / 1 = 0.2 = 20%
```

**结论**：每次下注总资本的**20%**，长期资本增长率最大。

### 为什么20%是最优？

**模拟**（1000次抛硬币，初始资本$100）：

| 下注比例 | 最终资本（平均） | 破产概率 |
|---------|-----------------|---------|
| 10%     | $1,523          | 0%      |
| 20%（Kelly） | $2,891  | 0%      |
| 30%     | $1,982          | 5%      |
| 50%     | $127            | 35%     |
| 100%    | $0              | 100%    |

**洞察**：
- <20%：过于保守，增长慢
- =20%：**最优**
- >20%：over-bet，破产风险↑，长期收益↓
- =100%：必然破产（gambler's ruin）

---

## 第二部分：交易中的Kelly公式

### 交易版Kelly公式

**简化版**（盈亏比固定）：

```
f* = (胜率 × 盈亏比 - 败率) / 盈亏比

或：

f* = (p × R - (1-p)) / R

其中：
R = 盈亏比 = 平均盈利 / 平均亏损
```

**案例1**：
- 胜率p = 40%
- 盈亏比R = 2:1（平均盈利$200，平均亏损$100）

**计算**：
```
f* = (0.4×2 - 0.6) / 2 = 0.1 = 10%
```

**结论**：单笔交易风险10%总资本。

**案例2**（更常见）：
- 胜率p = 55%
- 盈亏比R = 1.5:1

**计算**：
```
f* = (0.55×1.5 - 0.45) / 1.5
   = (0.825 - 0.45) / 1.5
   = 0.25 = 25%
```

### 期望值的前提

**Kelly公式的前提**：**正期望值**。

**期望值（EV）**：
```
EV = p × R - (1-p)

Kelly公式等价于：
f* = EV / R
```

**如果EV≤0**：
- Kelly公式→f*≤0
- 含义：**不要下注**（或做空）

**交易启示**：
- 先确保策略有正期望值
- 再用Kelly决定仓位

---

## 第三部分：Full Kelly vs Fractional Kelly

### Full Kelly的问题

**Full Kelly（f*=20%例子）**：
- 理论上最大化长期增长
- **但**：波动巨大，心理难以承受

**模拟数据**：
- Full Kelly（20%）：最大回撤-40%
- Half Kelly（10%）：最大回撤-18%

**心理问题**：
- -40%回撤→恐慌→放弃策略
- "理论最优≠实际最优"

### Fractional Kelly（分数Kelly）

**实践共识**：使用**1/2 Kelly**或**1/4 Kelly**。

**原因**：

**1. 参数估计误差**：
- 胜率、盈亏比=**估计值**（不是真实值）
- 如果高估→over-bet→灾难

**研究**（MacLean et al., 2010）：
- 高估胜率10%→Full Kelly导致长期收益下降50%
- Half Kelly对误差更robust

**2. 心理承受能力**：
- Half Kelly：回撤↓，更容易坚持

**3. 安全边际**：
- Buffett："Margin of Safety"
- 保守Kelly=风险缓冲

**推荐**：

| 风险偏好 | Kelly倍数 |
|---------|----------|
| 激进（职业交易者） | 0.5 - 0.75 Kelly |
| 稳健（大多数人） | 0.25 - 0.5 Kelly |
| 保守 | 0.1 - 0.25 Kelly |

---

## 第四部分：Kelly在中国A股的应用

### 参数估计挑战

**问题**：中国A股的胜率和盈亏比**不稳定**。

**数据**（某趋势策略，2015-2024）：

| 年份 | 胜率 | 盈亏比 | Kelly% |
|-----|------|--------|--------|
| 2015 | 62% | 1.8 | 27% |
| 2016 | 48% | 1.5 | 9% |
| 2017 | 55% | 1.6 | 18% |
| 2018 | 38% | 2.1 | 7% |

**结论**：
- 参数年度间波动巨大
- 用历史平均→可能over-bet

**解决方案**：

**1. 滚动窗口**：
- 用最近100笔交易计算（而非全部历史）
- 更反映当前市场环境

**2. 保守估计**：
- 胜率：用lower bound（如95%置信区间下限）
- 盈亏比：同样保守估计

**3. 动态调整**：
- 每月重新计算Kelly%
- 根据近期表现调整仓位

### A股特色考虑

**因素1：涨跌停限制**

**影响**：
- 盈利上限（+10%封死）
- 亏损下限（-10%无法止损）

**调整**：
- Kelly公式假设连续市场
- A股→实际盈亏比受限
- 建议：Kelly% × 0.8（安全系数）

**因素2：T+1制度**

**影响**：
- 当日买入，次日才能卖出
- 隔夜风险（开盘跳空）

**调整**：
- 增加隔夜风险权重
- 进一步降低Kelly%

**因素3：融资融券限制**

**A股融资融券**：
- 门槛高（50万）
- 杠杆有限（1:1）

**好处**：
- 限制了over-betting
- 降低破产风险

---

## 第五部分：Kelly的常见误区

### 误区1："Kelly说我应该all-in"

**错误理解**：
- Kelly=30%→我应该下注30%

**忽略**：
- 这是**单一**机会的Kelly
- 如果同时有**多个**机会？

**正确理解**：
- 如果持有10只股票，每只Kelly=10%
- 总仓位=100%（风险过高）
- **解决**：每只用0.5 Kelly（5%）→总仓位50%

### 误区2："Kelly保证不破产"

**事实**：
- Kelly最大化**长期增长率**
- 但**短期**仍可能大幅回撤

**例**：
- Full Kelly（20%），可能经历-40%回撤
- 如果心理无法承受→放弃策略→失败

**关键**：
- Kelly不保证"舒适"
- 只保证"长期最优"（如果你能坚持）

### 误区3："我的胜率很高，Kelly很大"

**问题**：过度自信，高估胜率。

**现实检验**：
- 回测胜率65% vs 实盘胜率52%
- 为什么？
  - 过拟合
  - 交易成本
  - 滑点
  - 情绪干扰

**防御**：
- 用**实盘数据**（不是回测）
- 保守估计
- Fractional Kelly

---

## 第六部分：案例研究

### 案例：张伟的Kelly之旅

**背景**：张伟，37岁，量化交易者，本金100万。

**策略**：
- 动量突破策略
- 回测数据（2018-2021）：
  - 胜率58%
  - 盈亏比1.6
  - Kelly = (0.58×1.6-0.42)/1.6 = 31.5%

**阶段1：Full Kelly灾难**（2022年1月）

**操作**：
- 直接使用Full Kelly（31.5%单笔）
- 第1月：5笔交易，3胜2负（符合预期）
  - 资本：100万→108万（+8%）
- **心态**："Kelly真神奇！"

**第2月**（2022年2月）：
- 遭遇连续亏损：负-负-负-胜-负
- 资本：108万→79万（-27%）
- **心态**：恐慌、怀疑、失眠
- **决策**：降低仓位至10%

**第3月**（2022年3月）：
- 策略反弹：胜-胜-胜
- 但因为仓位只有10%，资本：79万→85万（+8%）
- **痛苦**："如果我还用31%，现在是95万！"

**问题分析**：
- Full Kelly→波动过大→情绪化决策
- 在低点减仓、高点加仓（错误）

**阶段2：Half Kelly稳定**（2022年4月起）

**调整**：
- 使用**Half Kelly**（15%）
- 承诺：6个月内不改变

**结果**（2022年4-9月）：
- 仍有波动，但可承受
- 最大回撤：-18%（vs Full Kelly的-40%）
- 6个月后：85万→97万（+14%）

**心态**：
- "虽然增长比Full Kelly慢，但我能坚持"
- "坚持>理论最优"

**阶段3：参数动态调整**（2023年起）

**发现**（2023年1月）：
- 实盘胜率（2022）：52%（vs 回测58%）
- 实盘盈亏比：1.4（vs 回测1.6）

**新Kelly**：
```
f* = (0.52×1.4 - 0.48) / 1.4 = 17.7%
Half Kelly = 8.9%（约9%）
```

**调整**：
- 从15%降至9%
- "回测过拟合了，实盘要保守"

**结果**（2023-2024）：
- 年化收益：+13%（稳定）
- 最大回撤：-12%（可承受）
- **关键**：持续2年未放弃策略

**总结**：
- 100万（2022.1）→126万（2024.12）
- 如果用Full Kelly→可能在2022年2月放弃
- **Half Kelly + 保守估计 = 长期成功**

---

## 结语：Kelly不是公式，是哲学

**核心洞察**：
- Kelly公式的价值不是"精确数字"
- 而是**思维框架**：
  1. 只在有**正期望值**时下注
  2. 下注大小与**优势成正比**
  3. 永远留有**安全边际**（Fractional Kelly）
  4. **过度下注**是最大敌人

**Buffett的Kelly智慧**：
> "The most important thing is not how much you make, but how much you don't lose."

**实践原则**：
1. **计算Kelly**：了解理论上限
2. **减半（或更多）**：实际仓位=0.25-0.5 Kelly
3. **保守估计参数**：用实盘数据，不是回测
4. **动态调整**：每季度重新评估
5. **心理优先**：如果仍然睡不着→继续减仓

**下一步**：
- 4月10日：破产概率——赌徒的毁灭
- 4月14日：资金曲线管理——回撤控制

**记住Ed Thorp的话**：
> "The Kelly Criterion tells you the most you should bet. But it doesn't mean you have to bet that much."

---

## 附录：Kelly计算器

### 简化Kelly计算

**输入你的策略参数**：

1. 胜率（p）：___% （例：55%）
2. 平均盈利（W）：___元（例：$150）
3. 平均亏损（L）：___元（例：$100）

**计算**：

**Step 1：盈亏比（R）**
```
R = W / L = ___ / ___ = ___
```

**Step 2：Full Kelly**
```
f* = (p×R - (1-p)) / R
   = (___×___ - ___) / ___
   = ___%
```

**Step 3：Fractional Kelly（推荐）**
```
Half Kelly = f* / 2 = ___%
Quarter Kelly = f* / 4 = ___%
```

**Step 4：单笔风险金额**
```
单笔风险 = 总资本 × Fractional Kelly%
         = ___ × ___%
         = ___元
```

### 快速参考表

| 胜率 | 盈亏比 | Full Kelly | Half Kelly |
|-----|--------|-----------|-----------|
| 50% | 1.5    | 17%       | 8.5%      |
| 50% | 2.0    | 25%       | 12.5%     |
| 55% | 1.5    | 25%       | 12.5%     |
| 55% | 2.0    | 30%       | 15%       |
| 60% | 1.5    | 33%       | 16.5%     |
| 60% | 2.0    | 35%       | 17.5%     |

**注意**：
- 这是**单一策略**的Kelly
- 如果多策略/多持仓→需要分配

---

## 参考文献

1. Kelly, J. L. (1956). "A new interpretation of information rate." *Bell System Technical Journal*, 35(4), 917-926.
2. Thorp, E. O. (2006). "The Kelly Criterion in Blackjack, Sports Betting, and the Stock Market." *Handbook of Asset and Liability Management*, 385-428.
3. MacLean, L. C., et al. (2010). "Good and bad properties of the Kelly criterion." *Risk*, 20(2), 1-11.
4. Poundstone, W. (2005). *Fortune's Formula*. Hill and Wang.
